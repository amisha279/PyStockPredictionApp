<!DOCTYPE html>
<html>
<head>
    <title>Chatbox with Chart</title>
    <style>
        body { font-family: Arial; background: #f2f2f2; padding: 20px; }
        #chatbox { width: 100%; height: 250px; background: white; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; }
        .msg { margin: 8px 0; padding: 8px; border-radius: 5px; }
        .user { background: #d1e7ff; text-align: right; }
        .bot { background: #e8e8e8; text-align: left; }
        #input-area { margin-top: 10px; display: flex; }
        #message { flex: 1; padding: 10px; font-size: 16px; }
        #send-btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        #send-btn:hover { background: #0056b3; }
        #chart-container { margin-top: 20px; background: white; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<h2>Stock Chat</h2>

<div id="chatbox"></div>

<div id="input-area">
    <input type="text" id="message" placeholder="Type a stock symbol like AAPL...">
    <button id="send-btn">Send</button>
</div>

<div id="chart-container">
    <canvas id="priceChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.getElementById("send-btn").onclick = sendMessage;
    document.getElementById("message").addEventListener("keydown", e => {
        if (e.key === "Enter") sendMessage();
    });

    let chart = null;

    function sendMessage() {
        const msg = document.getElementById("message").value.trim();
        if (!msg) return;

        addMessage(msg, "user");
        document.getElementById("message").value = "";

        fetch("/predict", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ ticker: msg })
        })
        .then(res => res.json())
        .then(data => {
            addMessage(data.reply, "bot");
            if (data.dates && data.closes && data.predicted !== undefined) {
                updateChart(data.ticker, data.dates, data.closes, data.predicted);
            }
        })
        .catch(() => {
            addMessage("Error contacting server.", "bot");
        });
    }

    function addMessage(text, sender) {
        const chatbox = document.getElementById("chatbox");
        const div = document.createElement("div");
        div.className = "msg " + sender;
        div.innerText = text;
        chatbox.appendChild(div);
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    function updateChart(ticker, dates, closes, predicted) {
        const ctx = document.getElementById("priceChart").getContext("2d");

        const extendedDates = [...dates, "Predicted"];
        const extendedCloses = [...closes, predicted];

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: extendedDates,
                datasets: [
                    {
                        label: `${ticker} Close`,
                        data: extendedCloses,
                        borderColor: "blue",
                        fill: false,
                        pointRadius: 2
                    },
                    {
                        label: "Prediction",
                        data: new Array(closes.length).fill(null).concat([predicted]),
                        borderColor: "red",
                        borderDash: [5, 5],
                        pointRadius: 4,
                        pointBackgroundColor: "red"
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { display: true },
                    y: { display: true }
                }
            }
        });
    }
</script>

</body>
</html>
